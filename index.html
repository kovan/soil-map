<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Soil Organic Matter Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .info {
            padding: 10px 14px;
            background: white;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-radius: 8px;
            min-width: 200px;
        }

        .info h4 {
            margin: 0 0 8px;
            color: #333;
            font-size: 16px;
        }

        .info p {
            margin: 4px 0;
            color: #666;
            font-size: 14px;
        }

        .info .region-name {
            font-size: 18px;
            font-weight: 600;
            color: #222;
        }

        .info .country-name {
            font-size: 13px;
            color: #666;
            margin-top: 2px;
        }

        .info .percentage {
            font-size: 24px;
            font-weight: 700;
            color: #5D4037;
        }

        .legend {
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            line-height: 1.6;
        }

        .legend h4 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #333;
        }

        .legend i {
            width: 24px;
            height: 16px;
            float: left;
            margin-right: 8px;
            border-radius: 2px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            font-size: 12px;
            color: #555;
        }

        .title-control {
            background: rgba(255,255,255,0.95);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            text-align: center;
        }

        .title-control h1 {
            font-size: 20px;
            color: #333;
            margin: 0;
        }

        .title-control p {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .layer-toggle {
            background: rgba(255,255,255,0.95);
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .layer-toggle h4 {
            margin: 0 0 8px;
            font-size: 13px;
            color: #333;
        }

        .layer-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 4px 0;
            font-size: 13px;
            color: #555;
        }

        .layer-toggle input {
            margin-right: 8px;
        }

        .sources-control {
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 320px;
        }

        .sources-control h4 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .sources-control h4::after {
            content: '\25BC';
            font-size: 10px;
            transition: transform 0.2s;
        }

        .sources-control.collapsed h4::after {
            transform: rotate(-90deg);
        }

        .sources-control.collapsed .sources-content {
            display: none;
        }

        .sources-content {
            font-size: 12px;
            color: #555;
            line-height: 1.6;
        }

        .sources-content a {
            color: #5D4037;
            text-decoration: none;
        }

        .sources-content a:hover {
            text-decoration: underline;
        }

        .sources-content ul {
            margin: 8px 0;
            padding-left: 18px;
        }

        .sources-content li {
            margin: 4px 0;
        }

        .sources-content .note {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 11px;
            color: #888;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-size: 16px;
            color: #333;
        }

        .loading-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading-overlay">Loading map data...</div>
    <div id="debug" style="position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:white;padding:15px 20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.3);font-size:14px;z-index:1000;display:flex;gap:20px;align-items:center;">
        <div style="font-weight:bold;">Color Check (USA should be DARKER):</div>
        <div style="text-align:center;">
            <div id="usa-color" style="width:60px;height:40px;border:2px solid #333;"></div>
            <div>USA: <span id="usa-val"></span></div>
        </div>
        <div style="font-size:20px;">vs</div>
        <div style="text-align:center;">
            <div id="esp-color" style="width:60px;height:40px;border:2px solid #333;"></div>
            <div>Spain: <span id="esp-val"></span></div>
        </div>
        <button id="highlight-btn" style="padding:8px 12px;cursor:pointer;background:#5D4037;color:white;border:none;border-radius:4px;">Flash Countries</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Soil Organic Carbon data by country (% in topsoil, approximate averages)
        // Sources: FAO SOLAW, ISRIC SoilGrids, scientific literature
        const soilOrganicData = {
            // Europe
            "RUS": 2.8, "DEU": 2.1, "FRA": 1.9, "GBR": 3.2, "ITA": 1.6,
            "ESP": 1.4, "POL": 1.8, "UKR": 3.1, "ROU": 2.0, "NLD": 4.2,
            "BEL": 2.5, "CZE": 1.9, "GRC": 1.3, "PRT": 1.5, "SWE": 4.8,
            "HUN": 2.2, "AUT": 3.0, "CHE": 3.5, "BGR": 1.8, "DNK": 2.8,
            "FIN": 5.2, "SVK": 2.0, "NOR": 4.5, "IRL": 4.8, "HRV": 2.1,
            "BIH": 2.3, "ALB": 1.7, "LTU": 2.4, "SVN": 3.2, "LVA": 2.6,
            "EST": 3.0, "MKD": 1.9, "LUX": 2.3, "MNE": 2.5, "ISL": 6.5,
            "SRB": 2.1, "BLR": 2.5, "MDA": 2.8,

            // Asia
            "CHN": 1.5, "IND": 0.6, "JPN": 2.8, "IDN": 2.2, "PAK": 0.5,
            "BGD": 1.1, "VNM": 1.8, "THA": 1.2, "MMR": 1.5, "KOR": 2.0,
            "MYS": 2.5, "NPL": 1.4, "AFG": 0.7, "IRQ": 0.6, "SAU": 0.3,
            "UZB": 0.8, "YEM": 0.4, "PRK": 1.6, "SYR": 0.8, "KAZ": 1.8,
            "AZE": 1.5, "ARE": 0.2, "TJK": 1.2, "ISR": 0.9, "LAO": 1.6,
            "KGZ": 2.5, "TKM": 0.6, "GEO": 2.8, "OMN": 0.3, "MNG": 1.4,
            "ARM": 2.2, "QAT": 0.2, "BHR": 0.2, "KWT": 0.3, "LBN": 1.2,
            "JOR": 0.5, "PHL": 1.8, "KHM": 1.3, "LKA": 1.5, "BTN": 3.2,
            "TWN": 1.9, "TLS": 1.4,

            // Africa
            "NGA": 1.0, "ETH": 1.8, "EGY": 0.5, "COD": 2.2, "ZAF": 1.2,
            "TZA": 1.5, "KEN": 1.6, "SDN": 0.4, "DZA": 0.7, "MAR": 1.1,
            "UGA": 2.0, "GHA": 1.4, "MOZ": 1.1, "MDG": 2.5, "CMR": 2.0,
            "CIV": 1.3, "NER": 0.3, "BFA": 0.5, "MLI": 0.4, "MWI": 1.5,
            "ZMB": 1.2, "SEN": 0.6, "TCD": 0.5, "SOM": 0.4, "ZWE": 1.0,
            "GIN": 1.6, "RWA": 2.8, "BEN": 0.9, "BDI": 2.2, "TUN": 0.9,
            "SSD": 1.4, "TGO": 1.0, "SLE": 1.5, "LBY": 0.3, "CAF": 1.8,
            "MRT": 0.3, "ERI": 0.6, "NAM": 0.5, "BWA": 0.6, "GAB": 2.5,
            "LSO": 1.8, "GMB": 0.7, "GNB": 1.2, "COG": 2.3, "SWZ": 1.4,
            "AGO": 1.3, "LBR": 1.8, "GNQ": 2.4, "DJI": 0.3,

            // North America
            "USA": 2.0, "CAN": 3.5, "MEX": 1.6, "GTM": 2.2, "CUB": 2.0,
            "HTI": 1.2, "DOM": 1.8, "HND": 2.0, "NIC": 2.2, "SLV": 1.8,
            "CRI": 3.5, "PAN": 2.8, "JAM": 2.5, "TTO": 2.2, "BHS": 1.5,
            "BLZ": 2.5, "BRB": 1.8,

            // South America
            "BRA": 1.8, "ARG": 2.5, "COL": 3.2, "PER": 2.0, "VEN": 1.8,
            "CHL": 2.8, "ECU": 3.5, "BOL": 1.5, "PRY": 1.4, "URY": 3.2,
            "GUY": 2.8, "SUR": 2.5, "GUF": 3.0,

            // Oceania
            "AUS": 1.2, "PNG": 3.5, "NZL": 4.5, "FJI": 3.0, "SLB": 2.8,
            "VUT": 3.2, "NCL": 2.5,

            // Additional
            "CYP": 1.3, "XKX": 2.0
        };

        // Regional soil organic data (state/province level)
        // Format: "COUNTRY_CODE.REGION_CODE": value
        const regionalSoilData = {
            // USA States (USDA soil survey data)
            "USA.AL": 1.2, "USA.AK": 4.8, "USA.AZ": 0.8, "USA.AR": 1.5, "USA.CA": 1.4,
            "USA.CO": 1.8, "USA.CT": 2.8, "USA.DE": 1.6, "USA.FL": 1.9, "USA.GA": 1.1,
            "USA.HI": 3.5, "USA.ID": 2.2, "USA.IL": 3.2, "USA.IN": 2.8, "USA.IA": 3.8,
            "USA.KS": 2.0, "USA.KY": 1.8, "USA.LA": 1.6, "USA.ME": 3.5, "USA.MD": 1.8,
            "USA.MA": 2.5, "USA.MI": 2.8, "USA.MN": 4.2, "USA.MS": 1.3, "USA.MO": 2.0,
            "USA.MT": 2.5, "USA.NE": 2.4, "USA.NV": 0.7, "USA.NH": 3.2, "USA.NJ": 2.0,
            "USA.NM": 0.9, "USA.NY": 2.8, "USA.NC": 1.5, "USA.ND": 3.5, "USA.OH": 2.5,
            "USA.OK": 1.5, "USA.OR": 2.8, "USA.PA": 2.2, "USA.RI": 2.4, "USA.SC": 1.2,
            "USA.SD": 3.0, "USA.TN": 1.6, "USA.TX": 1.2, "USA.UT": 1.4, "USA.VT": 3.5,
            "USA.VA": 1.8, "USA.WA": 2.5, "USA.WV": 2.0, "USA.WI": 3.5, "USA.WY": 1.8,

            // Canada Provinces
            "CAN.AB": 3.8, "CAN.BC": 3.2, "CAN.MB": 4.5, "CAN.NB": 3.0, "CAN.NL": 4.2,
            "CAN.NS": 2.8, "CAN.NT": 5.5, "CAN.NU": 4.8, "CAN.ON": 3.2, "CAN.PE": 2.8,
            "CAN.QC": 3.8, "CAN.SK": 4.2, "CAN.YT": 5.0,

            // Australia States
            "AUS.ACT": 1.8, "AUS.NSW": 1.4, "AUS.NT": 0.6, "AUS.QLD": 1.0, "AUS.SA": 0.8,
            "AUS.TAS": 3.5, "AUS.VIC": 2.0, "AUS.WA": 0.7,

            // Brazil States
            "BRA.AC": 2.2, "BRA.AL": 1.2, "BRA.AP": 2.5, "BRA.AM": 2.8, "BRA.BA": 1.0,
            "BRA.CE": 0.8, "BRA.DF": 2.0, "BRA.ES": 1.5, "BRA.GO": 1.8, "BRA.MA": 1.2,
            "BRA.MT": 1.6, "BRA.MS": 1.8, "BRA.MG": 1.8, "BRA.PA": 2.5, "BRA.PB": 0.9,
            "BRA.PR": 2.8, "BRA.PE": 1.0, "BRA.PI": 0.8, "BRA.RJ": 1.5, "BRA.RN": 0.7,
            "BRA.RS": 2.5, "BRA.RO": 2.0, "BRA.RR": 2.2, "BRA.SC": 2.8, "BRA.SP": 1.8,
            "BRA.SE": 1.1, "BRA.TO": 1.5,

            // China Provinces
            "CHN.AH": 1.4, "CHN.BJ": 1.2, "CHN.CQ": 1.5, "CHN.FJ": 1.8, "CHN.GS": 1.0,
            "CHN.GD": 1.6, "CHN.GX": 1.8, "CHN.GZ": 2.2, "CHN.HI": 1.5, "CHN.HE": 1.0,
            "CHN.HL": 3.8, "CHN.HA": 1.2, "CHN.HB": 1.4, "CHN.HN": 1.5, "CHN.JS": 1.3,
            "CHN.JX": 1.6, "CHN.JL": 3.2, "CHN.LN": 2.5, "CHN.NM": 2.0, "CHN.NX": 0.9,
            "CHN.QH": 2.8, "CHN.SN": 1.2, "CHN.SD": 1.1, "CHN.SH": 1.2, "CHN.SX": 1.0,
            "CHN.SC": 1.8, "CHN.TJ": 1.0, "CHN.XZ": 1.5, "CHN.XJ": 0.8, "CHN.YN": 2.5,
            "CHN.ZJ": 1.5,

            // India States
            "IND.AN": 1.2, "IND.AP": 0.5, "IND.AR": 2.2, "IND.AS": 1.5, "IND.BR": 0.5,
            "IND.CT": 0.8, "IND.CH": 0.6, "IND.DN": 0.8, "IND.DD": 0.6, "IND.DL": 0.5,
            "IND.GA": 1.2, "IND.GJ": 0.6, "IND.HR": 0.5, "IND.HP": 1.8, "IND.JK": 1.5,
            "IND.JH": 0.7, "IND.KA": 0.6, "IND.KL": 1.5, "IND.LA": 0.8, "IND.LD": 0.5,
            "IND.MP": 0.6, "IND.MH": 0.7, "IND.MN": 2.0, "IND.ML": 2.5, "IND.MZ": 2.2,
            "IND.NL": 2.0, "IND.OR": 0.6, "IND.PY": 0.5, "IND.PB": 0.5, "IND.RJ": 0.4,
            "IND.SK": 2.8, "IND.TN": 0.5, "IND.TG": 0.5, "IND.TR": 1.2, "IND.UP": 0.5,
            "IND.UT": 1.5, "IND.WB": 0.8,

            // Russia Federal Districts
            "RUS.AMU": 3.0, "RUS.ARK": 3.5, "RUS.AST": 1.2, "RUS.BEL": 2.8, "RUS.BRY": 2.2,
            "RUS.VLA": 2.5, "RUS.VGG": 1.5, "RUS.VLG": 2.8, "RUS.VOR": 2.5, "RUS.YEV": 3.2,
            "RUS.ZAB": 2.8, "RUS.IVA": 2.5, "RUS.IRK": 3.2, "RUS.KGD": 2.8, "RUS.KLU": 2.2,
            "RUS.KAM": 4.5, "RUS.KEM": 3.0, "RUS.KIR": 3.2, "RUS.KOS": 2.5, "RUS.KDA": 2.0,
            "RUS.KYA": 3.5, "RUS.KGN": 2.8, "RUS.KRS": 2.5, "RUS.LEN": 3.0, "RUS.LIP": 2.5,
            "RUS.MAG": 4.0, "RUS.MOW": 2.2, "RUS.MOS": 2.5, "RUS.MUR": 3.8, "RUS.NIZ": 2.5,
            "RUS.NGR": 2.8, "RUS.NVS": 3.2, "RUS.OMS": 3.5, "RUS.ORE": 2.0, "RUS.ORL": 2.5,
            "RUS.PNZ": 2.2, "RUS.PER": 2.8, "RUS.PRI": 3.0, "RUS.PSK": 2.8, "RUS.ROS": 2.2,
            "RUS.RYA": 2.2, "RUS.SAM": 2.0, "RUS.SPE": 2.8, "RUS.SAR": 2.0, "RUS.SAK": 4.2,
            "RUS.SVE": 3.0, "RUS.SMO": 2.5, "RUS.TAM": 2.2, "RUS.TVE": 2.8, "RUS.TOM": 3.8,
            "RUS.TUL": 2.2, "RUS.TYU": 3.5, "RUS.ULY": 2.2, "RUS.KHA": 3.2, "RUS.CHE": 2.5,
            "RUS.YAR": 2.5,

            // Germany States (Bundesländer)
            "DEU.BW": 2.0, "DEU.BY": 2.3, "DEU.BE": 1.8, "DEU.BB": 1.5, "DEU.HB": 2.2,
            "DEU.HH": 2.0, "DEU.HE": 2.1, "DEU.MV": 1.8, "DEU.NI": 2.5, "DEU.NW": 2.2,
            "DEU.RP": 1.9, "DEU.SL": 1.8, "DEU.SN": 1.7, "DEU.ST": 1.6, "DEU.SH": 3.0,
            "DEU.TH": 1.8,

            // France Regions
            "FRA.ALS": 1.8, "FRA.AQU": 2.0, "FRA.AUV": 2.5, "FRA.BOU": 2.2, "FRA.BRE": 2.8,
            "FRA.CEN": 1.8, "FRA.CHA": 2.0, "FRA.COR": 2.5, "FRA.FRC": 2.2, "FRA.IDF": 1.6,
            "FRA.LAN": 1.5, "FRA.LIM": 2.8, "FRA.LOR": 1.9, "FRA.MID": 2.0, "FRA.NPC": 2.2,
            "FRA.BNO": 2.5, "FRA.HNO": 2.3, "FRA.PDL": 2.2, "FRA.PIC": 2.0, "FRA.POI": 2.0,
            "FRA.PAC": 1.4, "FRA.RHA": 2.2,

            // Spain Autonomous Communities
            "ESP.AN": 1.2, "ESP.AR": 1.5, "ESP.AS": 3.2, "ESP.IB": 1.8, "ESP.CN": 2.0,
            "ESP.CB": 2.8, "ESP.CM": 1.3, "ESP.CL": 1.5, "ESP.CT": 1.8, "ESP.CE": 0.8,
            "ESP.EX": 1.2, "ESP.GA": 3.5, "ESP.MD": 1.4, "ESP.ML": 0.8, "ESP.MC": 1.0,
            "ESP.NC": 2.2, "ESP.PV": 2.5, "ESP.RI": 1.8, "ESP.VC": 1.2,

            // Italy Regions
            "ITA.ABR": 2.0, "ITA.BAS": 1.5, "ITA.CAL": 1.8, "ITA.CAM": 1.6, "ITA.EMR": 2.2,
            "ITA.FVG": 2.5, "ITA.LAZ": 1.5, "ITA.LIG": 2.0, "ITA.LOM": 2.0, "ITA.MAR": 1.8,
            "ITA.MOL": 1.6, "ITA.PIE": 2.2, "ITA.PUG": 1.2, "ITA.SAR": 1.5, "ITA.SIC": 1.3,
            "ITA.TAA": 3.5, "ITA.TOS": 1.8, "ITA.UMB": 1.8, "ITA.VDA": 3.2, "ITA.VEN": 2.0,

            // Mexico States
            "MEX.AGU": 1.5, "MEX.BCN": 1.0, "MEX.BCS": 0.8, "MEX.CAM": 2.5, "MEX.CHP": 2.8,
            "MEX.CHH": 1.2, "MEX.COA": 1.0, "MEX.COL": 2.0, "MEX.DIF": 1.8, "MEX.DUR": 1.5,
            "MEX.GUA": 1.8, "MEX.GRO": 2.0, "MEX.HID": 2.2, "MEX.JAL": 2.0, "MEX.MEX": 2.0,
            "MEX.MIC": 2.2, "MEX.MOR": 2.0, "MEX.NAY": 2.2, "MEX.NLE": 1.2, "MEX.OAX": 2.5,
            "MEX.PUE": 2.0, "MEX.QUE": 1.8, "MEX.ROO": 2.2, "MEX.SLP": 1.5, "MEX.SIN": 1.8,
            "MEX.SON": 1.0, "MEX.TAB": 3.0, "MEX.TAM": 1.5, "MEX.TLA": 2.0, "MEX.VER": 2.8,
            "MEX.YUC": 2.0, "MEX.ZAC": 1.5,

            // Japan Prefectures
            "JPN.HOK": 4.5, "JPN.AOM": 3.2, "JPN.IWT": 2.8, "JPN.MYG": 2.5, "JPN.AKT": 3.0,
            "JPN.YGT": 2.8, "JPN.FKS": 2.5, "JPN.IBR": 2.2, "JPN.TCG": 2.5, "JPN.GNM": 2.8,
            "JPN.SAI": 2.0, "JPN.CHB": 2.2, "JPN.TKY": 1.8, "JPN.KNG": 2.0, "JPN.NGT": 3.2,
            "JPN.TYM": 2.8, "JPN.ISK": 2.5, "JPN.FKI": 2.5, "JPN.YMN": 2.8, "JPN.NGN": 3.5,
            "JPN.GIF": 2.5, "JPN.SZO": 2.2, "JPN.AIC": 2.0, "JPN.MIE": 2.2, "JPN.SHG": 2.5,
            "JPN.KYT": 2.2, "JPN.OSK": 1.8, "JPN.HYG": 2.2, "JPN.NAR": 2.0, "JPN.WKY": 2.5,
            "JPN.TTR": 2.5, "JPN.SMN": 2.5, "JPN.OKY": 2.2, "JPN.HRS": 2.2, "JPN.YGC": 2.5,
            "JPN.TKS": 2.2, "JPN.KGW": 2.0, "JPN.EHM": 2.2, "JPN.KCH": 2.8, "JPN.FKO": 2.2,
            "JPN.SAG": 2.5, "JPN.NGS": 2.5, "JPN.KMM": 2.8, "JPN.OIT": 2.5, "JPN.MYZ": 2.5,
            "JPN.KGS": 2.8, "JPN.OKN": 3.0
        };

        // Country code to name mapping for regional display
        const countryNames = {
            "USA": "United States", "CAN": "Canada", "AUS": "Australia",
            "BRA": "Brazil", "CHN": "China", "IND": "India", "RUS": "Russia",
            "DEU": "Germany", "FRA": "France", "ESP": "Spain", "ITA": "Italy",
            "MEX": "Mexico", "JPN": "Japan"
        };

        // Track current view mode
        let currentMode = 'country';
        let countryLayer = null;
        let regionalLayer = null;

        // Initialize map
        const map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            minZoom: 2,
            maxZoom: 8,
            worldCopyJump: true
        });

        // Add tile layer (simple gray basemap)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // Color scale function
        function getColor(value) {
            if (value === null || value === undefined) return '#ccc';
            return value >= 5   ? '#3E2723' :
                   value >= 4   ? '#4E342E' :
                   value >= 3   ? '#5D4037' :
                   value >= 2.5 ? '#6D4C41' :
                   value >= 2   ? '#795548' :
                   value >= 1.5 ? '#8D6E63' :
                   value >= 1   ? '#A1887F' :
                   value >= 0.5 ? '#BCAAA4' :
                   value > 0    ? '#D7CCC8' :
                                  '#EFEBE9';
        }

        // Style function for country GeoJSON
        function countryStyle(feature) {
            const countryCode = feature.properties['ISO3166-1-Alpha-3'];
            const value = soilOrganicData[countryCode];
            // Debug: log USA and Spain
            if (countryCode === 'USA' || countryCode === 'ESP') {
                console.log('Country:', countryCode, 'Value:', value, 'Color:', getColor(value));
            }
            return {
                fillColor: getColor(value),
                weight: 1,
                opacity: 1,
                color: '#fff',
                fillOpacity: 0.85
            };
        }

        // ISO 2-letter to 3-letter country code mapping
        const countryCodeMap = {
            "US": "USA", "CA": "CAN", "AU": "AUS", "BR": "BRA",
            "CN": "CHN", "IN": "IND", "RU": "RUS", "MX": "MEX",
            "AR": "ARG", "DE": "DEU", "FR": "FRA", "GB": "GBR",
            "IT": "ITA", "ES": "ESP", "JP": "JPN", "KR": "KOR"
        };

        // Name to code mapping for regions
        const regionNameToCode = {
            // US States
            "Alabama": "USA.AL", "Alaska": "USA.AK", "Arizona": "USA.AZ", "Arkansas": "USA.AR",
            "California": "USA.CA", "Colorado": "USA.CO", "Connecticut": "USA.CT", "Delaware": "USA.DE",
            "Florida": "USA.FL", "Georgia": "USA.GA", "Hawaii": "USA.HI", "Idaho": "USA.ID",
            "Illinois": "USA.IL", "Indiana": "USA.IN", "Iowa": "USA.IA", "Kansas": "USA.KS",
            "Kentucky": "USA.KY", "Louisiana": "USA.LA", "Maine": "USA.ME", "Maryland": "USA.MD",
            "Massachusetts": "USA.MA", "Michigan": "USA.MI", "Minnesota": "USA.MN", "Mississippi": "USA.MS",
            "Missouri": "USA.MO", "Montana": "USA.MT", "Nebraska": "USA.NE", "Nevada": "USA.NV",
            "New Hampshire": "USA.NH", "New Jersey": "USA.NJ", "New Mexico": "USA.NM", "New York": "USA.NY",
            "North Carolina": "USA.NC", "North Dakota": "USA.ND", "Ohio": "USA.OH", "Oklahoma": "USA.OK",
            "Oregon": "USA.OR", "Pennsylvania": "USA.PA", "Rhode Island": "USA.RI", "South Carolina": "USA.SC",
            "South Dakota": "USA.SD", "Tennessee": "USA.TN", "Texas": "USA.TX", "Utah": "USA.UT",
            "Vermont": "USA.VT", "Virginia": "USA.VA", "Washington": "USA.WA", "West Virginia": "USA.WV",
            "Wisconsin": "USA.WI", "Wyoming": "USA.WY", "District of Columbia": "USA.DC",
            // Canada Provinces
            "Alberta": "CAN.AB", "British Columbia": "CAN.BC", "Manitoba": "CAN.MB",
            "New Brunswick": "CAN.NB", "Newfoundland and Labrador": "CAN.NL", "Nova Scotia": "CAN.NS",
            "Northwest Territories": "CAN.NT", "Nunavut": "CAN.NU", "Ontario": "CAN.ON",
            "Prince Edward Island": "CAN.PE", "Quebec": "CAN.QC", "Saskatchewan": "CAN.SK",
            "Yukon": "CAN.YT", "Yukon Territory": "CAN.YT",
            // Australia States
            "Australian Capital Territory": "AUS.ACT", "New South Wales": "AUS.NSW",
            "Northern Territory": "AUS.NT", "Queensland": "AUS.QLD", "South Australia": "AUS.SA",
            "Tasmania": "AUS.TAS", "Victoria": "AUS.VIC", "Western Australia": "AUS.WA",
            // Brazil States
            "Acre": "BRA.AC", "Alagoas": "BRA.AL", "Amapá": "BRA.AP", "Amazonas": "BRA.AM",
            "Bahia": "BRA.BA", "Ceará": "BRA.CE", "Distrito Federal": "BRA.DF", "Espírito Santo": "BRA.ES",
            "Goiás": "BRA.GO", "Maranhão": "BRA.MA", "Mato Grosso": "BRA.MT", "Mato Grosso do Sul": "BRA.MS",
            "Minas Gerais": "BRA.MG", "Pará": "BRA.PA", "Paraíba": "BRA.PB", "Paraná": "BRA.PR",
            "Pernambuco": "BRA.PE", "Piauí": "BRA.PI", "Rio de Janeiro": "BRA.RJ",
            "Rio Grande do Norte": "BRA.RN", "Rio Grande do Sul": "BRA.RS", "Rondônia": "BRA.RO",
            "Roraima": "BRA.RR", "Santa Catarina": "BRA.SC", "São Paulo": "BRA.SP",
            "Sergipe": "BRA.SE", "Tocantins": "BRA.TO",
            // China Provinces
            "Anhui": "CHN.AH", "Beijing": "CHN.BJ", "Chongqing": "CHN.CQ", "Fujian": "CHN.FJ",
            "Gansu": "CHN.GS", "Guangdong": "CHN.GD", "Guangxi": "CHN.GX", "Guizhou": "CHN.GZ",
            "Hainan": "CHN.HI", "Hebei": "CHN.HE", "Heilongjian": "CHN.HL", "Heilongjiang": "CHN.HL",
            "Henan": "CHN.HA", "Hong Kong": "CHN.HK", "Hubei": "CHN.HB", "Hunan": "CHN.HN",
            "Inner Mongolia": "CHN.NM", "Jiangsu": "CHN.JS", "Jiangxi": "CHN.JX", "Jilin": "CHN.JL",
            "Liaoning": "CHN.LN", "Macau": "CHN.MO", "Ningxia": "CHN.NX", "Qinghai": "CHN.QH",
            "Shaanxi": "CHN.SN", "Shandong": "CHN.SD", "Shanghai": "CHN.SH", "Shanxi": "CHN.SX",
            "Sichuan": "CHN.SC", "Taiwan": "CHN.TW", "Tianjin": "CHN.TJ", "Tibet": "CHN.XZ",
            "Xinjiang": "CHN.XJ", "Yunnan": "CHN.YN", "Zhejiang": "CHN.ZJ",
            // India States
            "Andaman and Nicobar Islands": "IND.AN", "Andhra Pradesh": "IND.AP", "Arunachal Pradesh": "IND.AR",
            "Assam": "IND.AS", "Bihar": "IND.BR", "Chandigarh": "IND.CH", "Chhattisgarh": "IND.CT",
            "Dadra and Nagar Haveli": "IND.DN", "Daman and Diu": "IND.DD", "Delhi": "IND.DL",
            "Goa": "IND.GA", "Gujarat": "IND.GJ", "Haryana": "IND.HR", "Himachal Pradesh": "IND.HP",
            "Jammu and Kashmir": "IND.JK", "Jharkhand": "IND.JH", "Karnataka": "IND.KA",
            "Kerala": "IND.KL", "Ladakh": "IND.LA", "Lakshadweep": "IND.LD", "Madhya Pradesh": "IND.MP",
            "Maharashtra": "IND.MH", "Manipur": "IND.MN", "Meghalaya": "IND.ML", "Mizoram": "IND.MZ",
            "Nagaland": "IND.NL", "Odisha": "IND.OR", "Pondicherry": "IND.PY", "Puducherry": "IND.PY",
            "Punjab": "IND.PB", "Rajasthan": "IND.RJ", "Sikkim": "IND.SK", "Tamil Nadu": "IND.TN",
            "Telangana": "IND.TG", "Tripura": "IND.TR", "Uttar Pradesh": "IND.UP",
            "Uttarakhand": "IND.UT", "West Bengal": "IND.WB",
            // Germany States
            "Baden-Württemberg": "DEU.BW", "Bayern": "DEU.BY", "Berlin": "DEU.BE",
            "Brandenburg": "DEU.BB", "Bremen": "DEU.HB", "Hamburg": "DEU.HH",
            "Hessen": "DEU.HE", "Mecklenburg-Vorpommern": "DEU.MV", "Niedersachsen": "DEU.NI",
            "Nordrhein-Westfalen": "DEU.NW", "Rheinland-Pfalz": "DEU.RP", "Saarland": "DEU.SL",
            "Sachsen": "DEU.SN", "Sachsen-Anhalt": "DEU.ST", "Schleswig-Holstein": "DEU.SH",
            "Thüringen": "DEU.TH",
            // France Regions
            "Alsace": "FRA.ALS", "Aquitaine": "FRA.AQU", "Auvergne": "FRA.AUV",
            "Burgundy": "FRA.BOU", "Brittany": "FRA.BRE", "Centre": "FRA.CEN",
            "Champagne-Ardenne": "FRA.CHA", "Corsica": "FRA.COR", "Franche-Comté": "FRA.FRC",
            "Ile-de-France": "FRA.IDF", "Languedoc-Roussillon": "FRA.LAN", "Limousin": "FRA.LIM",
            "Lorraine": "FRA.LOR", "Midi-Pyrenées": "FRA.MID", "Nord-Pas de Calais": "FRA.NPC",
            "Lower Normandy": "FRA.BNO", "Upper Normandy": "FRA.HNO", "Pays-de-la-Loire": "FRA.PDL",
            "Picardy": "FRA.PIC", "Poitou-Charentes": "FRA.POI", "Provence-Alpes-Cote d'Azur": "FRA.PAC",
            "Rhone-Alpes": "FRA.RHA",
            // Spain Communities
            "Andalucia": "ESP.AN", "Aragon": "ESP.AR", "Asturias": "ESP.AS",
            "Baleares": "ESP.IB", "Canarias": "ESP.CN", "Cantabria": "ESP.CB",
            "Castilla-La Mancha": "ESP.CM", "Castilla-Leon": "ESP.CL", "Cataluña": "ESP.CT",
            "Ceuta": "ESP.CE", "Extremadura": "ESP.EX", "Galicia": "ESP.GA",
            "Madrid": "ESP.MD", "Melilla": "ESP.ML", "Murcia": "ESP.MC",
            "Navarra": "ESP.NC", "Pais Vasco": "ESP.PV", "La Rioja": "ESP.RI", "Valencia": "ESP.VC",
            // Italy Regions
            "Abruzzo": "ITA.ABR", "Basilicata": "ITA.BAS", "Calabria": "ITA.CAL",
            "Campania": "ITA.CAM", "Emilia-Romagna": "ITA.EMR", "Friuli Venezia Giulia": "ITA.FVG",
            "Lazio": "ITA.LAZ", "Liguria": "ITA.LIG", "Lombardia": "ITA.LOM", "Marche": "ITA.MAR",
            "Molise": "ITA.MOL", "Piemonte": "ITA.PIE", "Puglia": "ITA.PUG", "Sardegna": "ITA.SAR",
            "Sicilia": "ITA.SIC", "Trentino-Alto Adige/Sudtirol": "ITA.TAA", "Toscana": "ITA.TOS",
            "Umbria": "ITA.UMB", "Valle D'Aosta/Vallée D'Aoste": "ITA.VDA", "Veneto": "ITA.VEN",
            // Mexico States
            "Aguascalientes": "MEX.AGU", "Baja California": "MEX.BCN", "Baja California Sur": "MEX.BCS",
            "Campeche": "MEX.CAM", "Chiapas": "MEX.CHP", "Chihuahua": "MEX.CHH",
            "Coahuila": "MEX.COA", "Colima": "MEX.COL", "Distrito Federal": "MEX.DIF",
            "Ciudad de Mexico": "MEX.DIF", "Durango": "MEX.DUR", "Guanajuato": "MEX.GUA",
            "Guerrero": "MEX.GRO", "Hidalgo": "MEX.HID", "Jalisco": "MEX.JAL",
            "Mexico": "MEX.MEX", "México": "MEX.MEX", "Michoacán de Ocampo": "MEX.MIC",
            "Morelos": "MEX.MOR", "Nayarit": "MEX.NAY", "Nuevo Leon": "MEX.NLE",
            "Nuevo León": "MEX.NLE", "Oaxaca": "MEX.OAX", "Puebla": "MEX.PUE",
            "Querétaro": "MEX.QUE", "Quintana Roo": "MEX.ROO", "San Luis Potosí": "MEX.SLP",
            "Sinaloa": "MEX.SIN", "Sonora": "MEX.SON", "Tabasco": "MEX.TAB",
            "Tamaulipas": "MEX.TAM", "Tlaxcala": "MEX.TLA", "Veracruz": "MEX.VER",
            "Yucatán": "MEX.YUC", "Yucatan": "MEX.YUC", "Zacatecas": "MEX.ZAC",
            // Japan Prefectures (Japanese names)
            "北海道": "JPN.HOK", "青森県": "JPN.AOM", "岩手県": "JPN.IWT", "宮城県": "JPN.MYG",
            "秋田県": "JPN.AKT", "山形県": "JPN.YGT", "福島県": "JPN.FKS", "茨城県": "JPN.IBR",
            "栃木県": "JPN.TCG", "群馬県": "JPN.GNM", "埼玉県": "JPN.SAI", "千葉県": "JPN.CHB",
            "東京都": "JPN.TKY", "神奈川県": "JPN.KNG", "新潟県": "JPN.NGT", "富山県": "JPN.TYM",
            "石川県": "JPN.ISK", "福井県": "JPN.FKI", "山梨県": "JPN.YMN", "長野県": "JPN.NGN",
            "岐阜県": "JPN.GIF", "静岡県": "JPN.SZO", "愛知県": "JPN.AIC", "三重県": "JPN.MIE",
            "滋賀県": "JPN.SHG", "京都府": "JPN.KYT", "大阪府": "JPN.OSK", "兵庫県": "JPN.HYG",
            "奈良県": "JPN.NAR", "和歌山県": "JPN.WKY", "鳥取県": "JPN.TTR", "島根県": "JPN.SMN",
            "岡山県": "JPN.OKY", "広島県": "JPN.HRS", "山口県": "JPN.YGC", "徳島県": "JPN.TKS",
            "香川県": "JPN.KGW", "愛媛県": "JPN.EHM", "高知県": "JPN.KCH", "福岡県": "JPN.FKO",
            "佐賀県": "JPN.SAG", "長崎県": "JPN.NGS", "熊本県": "JPN.KMM", "大分県": "JPN.OIT",
            "宮崎県": "JPN.MYZ", "鹿児島県": "JPN.KGS", "沖縄県": "JPN.OKN"
        };

        // Get region code from properties
        function getRegionCode(props) {
            const name = props.name || props.NAME || props.admin || '';
            if (regionNameToCode[name]) {
                return regionNameToCode[name];
            }
            // Try ISO codes if available
            const countryCode = props.iso_a2 || props.ISO_A2 || '';
            const regionCode = props.iso_3166_2 || props.code_hasc || props.postal || '';
            const iso3 = countryCodeMap[countryCode] || '';
            if (regionCode) {
                const shortRegion = regionCode.split('-')[1] || regionCode.split('.')[1] || regionCode;
                return `${iso3}.${shortRegion}`;
            }
            return null;
        }

        // Get country from region code
        function getCountryFromRegion(regionCode) {
            if (!regionCode) return '';
            const countryCode = regionCode.split('.')[0];
            return countryNames[countryCode] || '';
        }

        // Style function for regional GeoJSON
        function regionalStyle(feature) {
            const props = feature.properties;
            const regionCode = getRegionCode(props);
            let value = regionCode ? regionalSoilData[regionCode] : null;

            // Fallback to country average if no regional data
            if ((value === null || value === undefined) && regionCode) {
                const countryCode = regionCode.split('.')[0];
                value = soilOrganicData[countryCode];
            }

            return {
                fillColor: getColor(value),
                weight: 0.5,
                opacity: 1,
                color: '#fff',
                fillOpacity: 0.85
            };
        }

        // Info control
        const info = L.control({ position: 'topright' });

        info.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        info.update = function(props, isRegional) {
            if (!props) {
                this._div.innerHTML = '<h4>Soil Organic Matter</h4><p>Hover over a ' + (currentMode === 'regional' ? 'region' : 'country') + '</p>';
                return;
            }

            if (isRegional) {
                const regionCode = getRegionCode(props);
                const regionName = props.name || props.NAME || props.admin || 'Unknown';
                const countryName = getCountryFromRegion(regionCode);

                let value = regionCode ? regionalSoilData[regionCode] : null;
                if ((value === null || value === undefined) && regionCode) {
                    const countryCode = regionCode.split('.')[0];
                    value = soilOrganicData[countryCode];
                }

                this._div.innerHTML = `
                    <h4>Soil Organic Matter</h4>
                    <p class="region-name">${regionName}</p>
                    <p class="country-name">${countryName}</p>
                    ${value !== undefined
                        ? `<p class="percentage">${value.toFixed(1)}%</p><p>of topsoil content</p>`
                        : '<p style="color:#999">No data available</p>'}
                `;
            } else {
                const countryCode = props['ISO3166-1-Alpha-3'];
                const countryName = props.name;
                const value = soilOrganicData[countryCode];

                this._div.innerHTML = `
                    <h4>Soil Organic Matter</h4>
                    <p class="region-name">${countryName}</p>
                    ${value !== undefined
                        ? `<p class="percentage">${value.toFixed(1)}%</p><p>of topsoil content</p>`
                        : '<p style="color:#999">No data available</p>'}
                `;
            }
        };

        info.addTo(map);

        // Title control
        const title = L.control({ position: 'topleft' });

        title.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'title-control');
            div.innerHTML = `
                <h1>World Soil Organic Matter</h1>
                <p>Average organic percentage in topsoil</p>
            `;
            return div;
        };

        title.addTo(map);

        // Layer toggle control
        const layerToggle = L.control({ position: 'topleft' });

        layerToggle.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'layer-toggle');
            div.innerHTML = `
                <h4>View Mode</h4>
                <label>
                    <input type="radio" name="layer" value="country" checked>
                    Countries
                </label>
                <label>
                    <input type="radio" name="layer" value="regional">
                    Regions/States
                </label>
            `;

            L.DomEvent.disableClickPropagation(div);

            div.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', function() {
                    switchLayer(this.value);
                });
            });

            return div;
        };

        layerToggle.addTo(map);

        // Sources control
        const sources = L.control({ position: 'bottomleft' });

        sources.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'sources-control');
            div.innerHTML = `
                <h4>Data Sources</h4>
                <div class="sources-content">
                    <p><strong>Primary Sources:</strong></p>
                    <ul>
                        <li><a href="https://www.fao.org/soils-portal" target="_blank">FAO Global Soil Partnership</a></li>
                        <li><a href="https://soilgrids.org" target="_blank">ISRIC SoilGrids</a></li>
                        <li><a href="https://www.nrcs.usda.gov/resources/data-and-reports/web-soil-survey" target="_blank">USDA Web Soil Survey</a></li>
                    </ul>
                    <p><strong>Methodology:</strong></p>
                    <p>Values represent average soil organic carbon percentage in topsoil (0-30cm depth). Regional data available for USA, Canada, Australia, Brazil, China, India, and Russia.</p>
                    <p class="note">Data compiled from multiple sources and may vary from local measurements. Last updated: 2024</p>
                </div>
            `;

            L.DomEvent.disableClickPropagation(div);

            div.querySelector('h4').addEventListener('click', function() {
                div.classList.toggle('collapsed');
            });

            return div;
        };

        sources.addTo(map);

        // Legend control
        const legend = L.control({ position: 'bottomright' });

        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            const grades = [0, 0.5, 1, 1.5, 2, 2.5, 3, 4, 5];

            div.innerHTML = '<h4>Organic Matter %</h4>';

            for (let i = grades.length - 1; i >= 0; i--) {
                const from = grades[i];
                const to = grades[i + 1];
                div.innerHTML += `
                    <div class="legend-item">
                        <i style="background:${getColor(from + 0.1)}"></i>
                        ${from}${to ? '&ndash;' + to : '+'}%
                    </div>
                `;
            }

            div.innerHTML += `
                <div class="legend-item">
                    <i style="background:#ccc"></i>
                    No data
                </div>
            `;

            return div;
        };

        legend.addTo(map);

        // Interaction functions for country layer
        function highlightCountry(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 2,
                color: '#333',
                fillOpacity: 0.95
            });
            layer.bringToFront();
            info.update(layer.feature.properties, false);
        }

        function resetCountryHighlight(e) {
            if (countryLayer) {
                countryLayer.resetStyle(e.target);
            }
            info.update();
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds(), { padding: [50, 50] });
        }

        function onEachCountry(feature, layer) {
            layer.on({
                mouseover: highlightCountry,
                mouseout: resetCountryHighlight,
                click: zoomToFeature
            });
        }

        // Interaction functions for regional layer
        function highlightRegion(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 2,
                color: '#333',
                fillOpacity: 0.95
            });
            layer.bringToFront();
            info.update(layer.feature.properties, true);
        }

        function resetRegionHighlight(e) {
            const layer = e.target;
            layer.setStyle(regionalStyle(layer.feature));
            info.update();
        }

        function onEachRegion(feature, layer) {
            layer.on({
                mouseover: highlightRegion,
                mouseout: resetRegionHighlight,
                click: zoomToFeature
            });
        }

        // Switch between layers
        function switchLayer(mode) {
            currentMode = mode;

            if (mode === 'country') {
                if (regionalLayer) {
                    map.removeLayer(regionalLayer);
                }
                if (countryLayer) {
                    countryLayer.addTo(map);
                }
            } else {
                if (countryLayer) {
                    map.removeLayer(countryLayer);
                }
                if (regionalLayer) {
                    regionalLayer.addTo(map);
                } else {
                    loadRegionalData();
                }
            }

            info.update();
        }

        // Load regional GeoJSON data
        function loadRegionalData() {
            document.getElementById('loading').classList.remove('hidden');

            // Load all regional data in parallel
            const baseUrl = 'https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/';
            Promise.all([
                fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'canada.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'australia.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'brazil-states.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'china.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'india.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'germany.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'france-regions.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'spain-communities.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'italy-regions.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'mexico.geojson').then(r => r.json()).catch(() => null),
                fetch(baseUrl + 'japan.geojson').then(r => r.json()).catch(() => null)
            ])
            .then((datasets) => {
                regionalLayer = L.layerGroup();

                const addGeoJson = (data) => {
                    if (data) {
                        L.geoJson(data, {
                            style: regionalStyle,
                            onEachFeature: onEachRegion
                        }).eachLayer(layer => regionalLayer.addLayer(layer));
                    }
                };

                datasets.forEach(addGeoJson);

                regionalLayer.addTo(map);
                document.getElementById('loading').classList.add('hidden');
            })
            .catch(error => {
                console.error('Error loading regional GeoJSON:', error);
                document.getElementById('loading').innerHTML = 'Error loading regional data. <a href="#" onclick="location.reload()">Refresh</a>';
            });
        }

        // Load country GeoJSON data
        fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
            .then(response => response.json())
            .then(data => {
                countryLayer = L.geoJson(data, {
                    style: countryStyle,
                    onEachFeature: onEachCountry
                }).addTo(map);
                document.getElementById('loading').classList.add('hidden');

                // Debug: show color comparison
                const usaVal = soilOrganicData['USA'];
                const espVal = soilOrganicData['ESP'];
                document.getElementById('usa-color').style.background = getColor(usaVal);
                document.getElementById('usa-val').textContent = usaVal + '%';
                document.getElementById('esp-color').style.background = getColor(espVal);
                document.getElementById('esp-val').textContent = espVal + '%';
                console.log('USA:', usaVal, '→', getColor(usaVal));
                console.log('ESP:', espVal, '→', getColor(espVal));

                // Store references to USA and Spain layers for highlighting
                let usaLayer = null;
                let espLayer = null;
                countryLayer.eachLayer(layer => {
                    const code = layer.feature.properties['ISO3166-1-Alpha-3'];
                    if (code === 'USA') usaLayer = layer;
                    if (code === 'ESP') espLayer = layer;
                });

                // Flash button handler
                document.getElementById('highlight-btn').addEventListener('click', () => {
                    const flashLayer = (layer, name) => {
                        if (!layer) {
                            console.log(name + ' layer not found');
                            return;
                        }
                        const origStyle = { ...layer.options };
                        // Flash red
                        layer.setStyle({ fillColor: '#ff0000', fillOpacity: 1, weight: 3, color: '#000' });
                        setTimeout(() => {
                            layer.setStyle({ fillColor: '#ffff00', fillOpacity: 1 });
                            setTimeout(() => {
                                layer.setStyle(countryStyle(layer.feature));
                            }, 300);
                        }, 300);
                    };
                    flashLayer(usaLayer, 'USA');
                    flashLayer(espLayer, 'Spain');

                    // Also log their current fill colors
                    if (usaLayer) {
                        const usaPath = usaLayer.getElement();
                        console.log('USA SVG fill:', usaPath ? usaPath.getAttribute('fill') : 'no element');
                        console.log('USA fill-opacity:', usaPath ? usaPath.getAttribute('fill-opacity') : 'no element');
                    }
                    if (espLayer) {
                        const espPath = espLayer.getElement();
                        console.log('Spain SVG fill:', espPath ? espPath.getAttribute('fill') : 'no element');
                        console.log('Spain fill-opacity:', espPath ? espPath.getAttribute('fill-opacity') : 'no element');
                    }
                });

                // Log actual SVG colors after a short delay
                setTimeout(() => {
                    const usaEl = usaLayer?.getElement();
                    const espEl = espLayer?.getElement();
                    console.log('=== ACTUAL SVG ATTRIBUTES ===');
                    console.log('USA element:', usaEl ? {
                        fill: usaEl.getAttribute('fill'),
                        fillOpacity: usaEl.getAttribute('fill-opacity'),
                        stroke: usaEl.getAttribute('stroke'),
                        style: usaEl.getAttribute('style')
                    } : 'not found');
                    console.log('Spain element:', espEl ? {
                        fill: espEl.getAttribute('fill'),
                        fillOpacity: espEl.getAttribute('fill-opacity'),
                        stroke: espEl.getAttribute('stroke'),
                        style: espEl.getAttribute('style')
                    } : 'not found');
                }, 1000);
            })
            .catch(error => {
                console.error('Error loading GeoJSON:', error);
                document.getElementById('loading').innerHTML = 'Error loading map data. <a href="#" onclick="location.reload()">Refresh</a>';
            });
    </script>
</body>
</html>
